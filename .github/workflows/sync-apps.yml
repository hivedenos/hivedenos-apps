name: Sync Apps Catalog

on:
  schedule:
    - cron: '0 2 * * *'
  workflow_dispatch:

permissions:
  contents: write

jobs:
  sync:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: '3.11'

      - name: Install Python dependencies
        run: python -m pip install --upgrade pip pyyaml

      - name: Ensure scripts executable
        run: chmod +x scripts/run-sync.sh scripts/lib/*.sh scripts/pipeline/*.sh scripts/sources/umbrel/*.sh scripts/sources/awesome-docker-compose/*.sh scripts/assets/umbrel-gallery/*.sh scripts/channels/*.sh

      - name: Run sync pipeline
        run: ./scripts/run-sync.sh

      - name: Commit and push changes
        env:
          GIT_AUTHOR_NAME: hiveden-bot
          GIT_AUTHOR_EMAIL: bot@hiveden.local
          GIT_COMMITTER_NAME: hiveden-bot
          GIT_COMMITTER_EMAIL: bot@hiveden.local
        run: |
          if [[ -z "$(git status --porcelain -- data/apps.json data/metadata.json apps/)" ]]; then
            echo "No changes to commit"
            exit 0
          fi

          git add data/apps.json data/metadata.json apps/
          git commit -m "chore(apps): nightly sync from configured sources [skip ci]"
          git push
